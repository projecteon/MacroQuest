#include includes\ini.inc
#include includes\common.inc
#include includes\wait4rez.inc
#turbo 40

Sub Main
    /declare bardIniFileName        string  outer "ini/${MacroQuest.Server}/Bard_${Me.CleanName}.ini"

    /call InitBardIni ${bardIniFileName}
    /if (${Macro.Return} == 0) {
        /echo "Bootstrapped INI file, please update variables in: ${bardIniFileName}"
        /endmacro
    }

    /echo "Bard rock'n'rolling!"
    /bca "Bard rock'n'rolling!"

    :BardLoop
        /call Wait4Rez_Background_Events
        /if (${Me.Invis}) /goto :BardLoop
        
        /call doKill
        /goto :BardLoop
/return

Sub doKill
	/if (!${Melee.Enable} || ${Melee.Combat}) /return
    
    /declare targetId int local ${NetBots[${mainAssist}].TargetID}

    /if (!${targetId}) /return

    /declare isNPC local ${Spawn[${targetId}].Type.Equal[NPC]}
    /declare isPet local ${Spawn[${targetId}].Type.Equal[PET]}

    /if (!${isNPC} && !${isPet}) /return  
	/if (${SpawnCount[los id ${targetId}]} < 1) /return
	/if (${NetBots[${mainAssist}].TargetHP} > ${assistPct}) /return

	/target id ${targetId}
    /if (!${Target.ID} || ${Target.ID}==${Me.ID} || ${Target.ID}!=${targetId}) {
        /return
    }
    
	/killthis

    :gotoloopkeepfighting
        /if (${Target.ID} && ${Me.Combat} && ${Target.Type.Equal[NPC]}) {
            /delay 10
            /doevents
            /if (${Debug}) /echo DEBUG: KillMob: Combat Loop
            /goto :gotoloopkeepfighting            
        } 
/return


Sub InitBardIni(string iniFileName, string mainAssist)
    /declare bardOptions       string  outer "BardOptions"
    /declare parentInitResult  int     local 1

    /call InitGenralIni "${iniFileName}"
    /varset parentInitResult ${Macro.Return}
    
    /call InitWait4Rez "${iniFileName}"
    /if (${Macro.Return} == 0) {
        /varset parentInitResult 0
    }
    
/return ${parentInitResult}